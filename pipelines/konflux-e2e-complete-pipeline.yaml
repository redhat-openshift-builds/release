apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: e2e-openshift-builds
spec:
  description: |
    An integration test which provisions an ephemeral Hypershift cluster and deploys an Operator
    bundle from a Konflux snapshot. Enhanced with custom rh-operator builds and auto-generated BuildRuns.
  params:
    - description: Snapshot of the application
      name: SNAPSHOT
      default: '{"components": [{"name":"test-app", "containerImage": "quay.io/example/repo:latest"}]}'
      type: string
    - description: Builds for OpenShift Version
      name: VERSION
      default: "-1-6"
      type: string
  tasks:
    - name: provision-eaas-space
      taskRef:
        resolver: git
        params:
          - name: url
            value: https://github.com/konflux-ci/build-definitions.git
          - name: revision
            value: main
          - name: pathInRepo
            value: task/eaas-provision-space/0.1/eaas-provision-space.yaml
      params:
        - name: ownerName
          value: $(context.pipelineRun.name)
        - name: ownerUid
          value: $(context.pipelineRun.uid)
    - name: provision-cluster
      runAfter:
        - provision-eaas-space
      taskSpec:
        results:
          - name: clusterName
            value: "$(steps.create-cluster.results.clusterName)"
        steps:
          - name: get-supported-versions
            ref:
              resolver: git
              params:
                - name: url
                  value: https://github.com/konflux-ci/build-definitions.git
                - name: revision
                  value: main
                - name: pathInRepo
                  value: stepactions/eaas-get-supported-ephemeral-cluster-versions/0.1/eaas-get-supported-ephemeral-cluster-versions.yaml
            params:
              - name: eaasSpaceSecretRef
                value: $(tasks.provision-eaas-space.results.secretRef)
          - name: pick-version
            ref:
              resolver: git
              params:
                - name: url
                  value: https://github.com/konflux-ci/build-definitions.git
                - name: revision
                  value: main
                - name: pathInRepo
                  value: stepactions/eaas-get-latest-openshift-version-by-prefix/0.1/eaas-get-latest-openshift-version-by-prefix.yaml
            params:
              - name: prefix
                value: "$(steps.get-supported-versions.results.versions[0])."
          - name: create-cluster
            ref:
              resolver: git
              params:
                - name: url
                  value: https://github.com/konflux-ci/build-definitions.git
                - name: revision
                  value: main
                - name: pathInRepo
                  value: stepactions/eaas-create-ephemeral-cluster-hypershift-aws/0.1/eaas-create-ephemeral-cluster-hypershift-aws.yaml
            params:
              - name: eaasSpaceSecretRef
                value: $(tasks.provision-eaas-space.results.secretRef)
              - name: version
                value: "$(steps.pick-version.results.version)"
              - name: instanceType
                value: m5.2xlarge
              - name: fips
                value: "true"
              - name: imageContentSources
                value: |
                    - source: registry.redhat.io/openshift-builds/openshift-builds-rhel9-operator
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-operator$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-operator-bundle
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-operator-bundle$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-controller-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-controller$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-image-processing-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-image-processing$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-image-bundler-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-image-bundler$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-git-cloner-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-git-cloner$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-waiters-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-waiter$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-webhook-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-webhook$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-shared-resource-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-shared-resource$(params.VERSION)
                    - source: registry.redhat.io/openshift-builds/openshift-builds-shared-resource-webhook-rhel9
                      mirrors:
                        - quay.io/redhat-user-workloads/rh-openshift-builds-tenant/openshift-builds-shared-resource-webhook$(params.VERSION)
    - name: verify-fips-enabled-on-nodes
      description: Verify that FIPS is enabled on cluster nodes
      runAfter:
        - provision-cluster
      taskSpec:
        volumes:
          - name: credentials
            emptyDir: { }
        steps:
          - name: get-kubeconfig
            ref:
              resolver: git
              params:
                - name: url
                  value: https://github.com/konflux-ci/build-definitions.git
                - name: revision
                  value: main
                - name: pathInRepo
                  value: stepactions/eaas-get-ephemeral-cluster-credentials/0.1/eaas-get-ephemeral-cluster-credentials.yaml
            params:
              - name: eaasSpaceSecretRef
                value: $(tasks.provision-eaas-space.results.secretRef)
              - name: clusterName
                value: "$(tasks.provision-cluster.results.clusterName)"
              - name: credentials
                value: credentials
          - name: check-fips
            image: quay.io/openshift-pipeline/ci:latest
            env:
              - name: KUBECONFIG
                value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
            volumeMounts:
              - name: credentials
                mountPath: /credentials
            script: |
              #!/usr/bin/env bash
              set -ex -u -o pipefail
              
              echo "Verifying FIPS compliance on cluster nodes..."
              
              # Get all worker nodes
              WORKER_NODES=$(oc get nodes -l node-role.kubernetes.io/worker -o jsonpath='{.items[*].metadata.name}')
              
              if [ -z "$WORKER_NODES" ]; then
                  echo "No worker nodes found. Checking all nodes..."
                  WORKER_NODES=$(oc get nodes -o jsonpath='{.items[*].metadata.name}')
              fi
              
              echo "Found nodes: $WORKER_NODES"
              
              # Check FIPS on each node
              for NODE in $WORKER_NODES; do
                  echo "Checking FIPS status on node: $NODE"
                  
                  # Create a debug pod to check FIPS status
                  FIPS_STATUS=$(oc debug node/$NODE --image=quay.io/openshift-pipeline/ci:latest -- chroot /host cat /proc/sys/crypto/fips_enabled 2>/dev/null || echo "Failed to check")
                  
                  echo "FIPS status on $NODE: $FIPS_STATUS"
                  
                  if [ "$FIPS_STATUS" = "1" ]; then
                      echo "PASS: Node $NODE has FIPS enabled"
                  elif [ "$FIPS_STATUS" = "0" ]; then
                      echo "FAIL: Node $NODE has FIPS disabled"
                      exit 1
                  else
                      echo "FAIL: Failed to check FIPS status on node $NODE: $FIPS_STATUS"
                      exit 1
                  fi
              done
              
              echo "All nodes have FIPS enabled"
    - name: install-openshift-pipelines
      runAfter:
        - verify-fips-enabled-on-nodes
      taskSpec:
        volumes:
          - name: credentials
            emptyDir: { }
        steps:
          - name: get-kubeconfig
            ref:
              resolver: git
              params:
                - name: url
                  value: https://github.com/konflux-ci/build-definitions.git
                - name: revision
                  value: main
                - name: pathInRepo
                  value: stepactions/eaas-get-ephemeral-cluster-credentials/0.1/eaas-get-ephemeral-cluster-credentials.yaml
            params:
              - name: eaasSpaceSecretRef
                value: $(tasks.provision-eaas-space.results.secretRef)
              - name: clusterName
                value: "$(tasks.provision-cluster.results.clusterName)"
              - name: credentials
                value: credentials
          - name: install-pipelines
            image: registry.redhat.io/openshift4/ose-cli:latest
            env:
              - name: KUBECONFIG
                value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
            volumeMounts:
              - name: credentials
                mountPath: /credentials
            script: |
              #!/usr/bin/env bash
              set -ex -u -o pipefail
              
              oc apply -f - <<EOF
              apiVersion: operators.coreos.com/v1alpha1
              kind: Subscription
              metadata:
                name: openshift-pipelines-operator
                namespace: openshift-operators
              spec:
                channel: latest
                name: openshift-pipelines-operator-rh
                source: redhat-operators
                sourceNamespace: openshift-marketplace
              EOF
              
              NAMESPACE="openshift-operators"
              DEPLOYMENTS=(
                  "openshift-pipelines-operator"
                  "tekton-operator-webhook"
              )
              
              echo "=== Waiting for OpenShift Pipelines installation ==="
              sleep 60
              
              for DEPLOYMENT in "${DEPLOYMENTS[@]}"; do
                  echo "=== Waiting for deployment: $DEPLOYMENT ==="
                  
                  if ! oc get deployment "$DEPLOYMENT" --namespace="$NAMESPACE" >/dev/null 2>&1; then
                      echo "ERROR: Deployment $DEPLOYMENT does not exist"
                      oc get deployments -n $NAMESPACE
                      exit 1
                  fi
                  
                  if ! oc wait deployment "$DEPLOYMENT" --namespace="$NAMESPACE" --for="condition=available" --timeout="180s"; then
                      echo "ERROR: Deployment $DEPLOYMENT failed to become available"
                      oc get deployment "$DEPLOYMENT" --namespace="$NAMESPACE" -o yaml
                      exit 1
                  fi
                  
                  echo "Deployment $DEPLOYMENT is available"
              done
              
              echo "OpenShift Pipelines installed successfully"
    - name: deploy-and-verify-operator
      description: Deploy operator and verify operands, CR status, and images from PR
      runAfter:
        - install-openshift-pipelines
      taskSpec:
        volumes:
          - name: credentials
            emptyDir: { }
        steps:
          - name: get-kubeconfig
            ref:
              resolver: git
              params:
                - name: url
                  value: https://github.com/konflux-ci/build-definitions.git
                - name: revision
                  value: main
                - name: pathInRepo
                  value: stepactions/eaas-get-ephemeral-cluster-credentials/0.1/eaas-get-ephemeral-cluster-credentials.yaml
            params:
              - name: eaasSpaceSecretRef
                value: $(tasks.provision-eaas-space.results.secretRef)
              - name: clusterName
                value: "$(tasks.provision-cluster.results.clusterName)"
              - name: credentials
                value: credentials
          - name: deploy-operator
            image: registry.redhat.io/openshift4/ose-cli:latest
            env:
              - name: SNAPSHOT
                value: $(params.SNAPSHOT)
              - name: KUBECONFIG
                value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
            volumeMounts:
              - name: credentials
                mountPath: /credentials
            script: |
              #!/usr/bin/env bash
              set -ex -u -o pipefail
              
              echo "Install operator-sdk and dependencies"
              dnf -y install jq
              export OPERATOR_SDK_VERSION=1.36.1
              export ARCH=$(case $(uname -m) in x86_64) echo -n amd64 ;; aarch64) echo -n arm64 ;; *) echo -n $(uname -m) ;; esac)
              export OPERATOR_SDK_DL_URL=https://github.com/operator-framework/operator-sdk/releases/download/v${OPERATOR_SDK_VERSION}
              curl -Lo /usr/local/bin/operator-sdk ${OPERATOR_SDK_DL_URL}/operator-sdk_linux_${ARCH}
              chmod +x /usr/local/bin/operator-sdk
              operator-sdk version
              
              echo "Find bundle image in snapshot"
              BUNDLE_IMAGE=$(jq -r '.components[] | select(.name | startswith("openshift-builds-operator-bundle")) | .containerImage' <<< "$SNAPSHOT" | head -1)
              [ -z "$BUNDLE_IMAGE" ] && echo "ERROR: Bundle image not found" && exit 1
              echo "Bundle: $BUNDLE_IMAGE"
              
              echo "Install operator"
              oc create namespace openshift-builds --dry-run=client -o yaml | oc apply -f -
              operator-sdk run bundle --timeout=5m --namespace openshift-builds "$BUNDLE_IMAGE"
              
              echo "Create OpenShiftBuild CR from operator's alm-examples"
              CSV_NAME=$(oc get csv -n openshift-builds -o name | grep openshift-builds-operator | head -1)
              oc get $CSV_NAME -n openshift-builds -o jsonpath='{.metadata.annotations.alm-examples}' | jq '.[0]' | oc apply -f -
              # Note: ShipwrightBuild CR is auto-created by the OpenShiftBuild operator
              
              echo "Wait for deployments to be created"
              for i in {1..60}; do
                  if oc get deployment shipwright-build-controller -n openshift-builds &>/dev/null && \
                     oc get deployment shipwright-build-webhook -n openshift-builds &>/dev/null && \
                     oc get deployment shared-resource-csi-driver-webhook -n openshift-builds &>/dev/null && \
                     oc get daemonset shared-resource-csi-driver-node -n openshift-builds &>/dev/null; then
                      echo "All deployments found"
                      break
                  fi
                  echo "Waiting for operator to create deployments... ($i/60)"
                  sleep 10
              done
              
              echo "Add SCC permissions"
              oc adm policy add-scc-to-user anyuid -z shipwright-build-controller -n openshift-builds
              oc adm policy add-scc-to-user anyuid -z shipwright-build-webhook -n openshift-builds
              
              echo "Create pipeline service account"
              oc create serviceaccount pipeline -n openshift-builds 2>/dev/null || true
              oc adm policy add-scc-to-user privileged -z pipeline -n openshift-builds
              oc adm policy add-role-to-user edit -z pipeline -n openshift-builds
              
              echo "Grant SCC for BuildKit tests"
              oc adm policy add-scc-to-group privileged system:serviceaccounts:openshift-builds
              oc adm policy add-scc-to-user privileged -z default -n openshift-builds
              
              oc adm policy add-scc-to-group anyuid system:serviceaccounts:openshift-builds
              oc create rolebinding privileged-scc-binding -n openshift-builds --clusterrole=system:openshift:scc:privileged --group=system:serviceaccounts:openshift-builds 2>/dev/null || true
              
              echo "Wait for rollout"
              oc rollout status deployment/shipwright-build-controller -n openshift-builds --timeout=10m
              oc rollout status deployment/shipwright-build-webhook -n openshift-builds --timeout=5m
              oc rollout status deployment/shared-resource-csi-driver-webhook -n openshift-builds --timeout=15m
              oc rollout status daemonset/shared-resource-csi-driver-node -n openshift-builds --timeout=15m
              
              echo "Operator deployed successfully"
          - name: verify-operands
            image: quay.io/openshift-pipeline/ci:latest
            env:
              - name: KUBECONFIG
                value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
            volumeMounts:
              - name: credentials
                mountPath: /credentials
            script: |
              #!/usr/bin/env bash
              set -ex -u -o pipefail
              
              OPERANDS=(
                  "deployment/shipwright-build-controller"
                  "deployment/shipwright-build-webhook"
                  "deployment/shared-resource-csi-driver-webhook"
                  "daemonset/shared-resource-csi-driver-node"
              )
              
              for OPERAND in "${OPERANDS[@]}"; do
                  if ! oc get "$OPERAND" -n openshift-builds &>/dev/null; then
                      echo "ERROR: $OPERAND not found"
                      exit 1
                  fi
                  
                  if ! oc rollout status "$OPERAND" -n openshift-builds --timeout=5m; then
                      echo "ERROR: $OPERAND failed to roll out"
                      oc describe "$OPERAND" -n openshift-builds
                      exit 1
                  fi
                  
                  echo "$OPERAND is ready"
              done
              
              echo "All operands deployed."
          - name: verify-cr-status
            image: quay.io/openshift-pipeline/ci:latest
            env:
              - name: KUBECONFIG
                value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
            volumeMounts:
              - name: credentials
                mountPath: /credentials
            script: |
              #!/usr/bin/env bash
              set -ex -u -o pipefail

              oc wait --for=condition=Ready openshiftbuild/cluster --timeout=5m
              oc get openshiftbuild/cluster -o jsonpath='{range .status.conditions[*]}  {.type}: {.status} ({.reason}){"\n"}{end}'
              
              echo "Waiting for ShipwrightBuild CR to be created"
              for i in {1..30}; do
                  if oc get shipwrightbuild -o name | head -1 &>/dev/null; then
                      break
                  fi
                  sleep 5
              done
              
              SHIPWRIGHT_CR=$(oc get shipwrightbuild -o name | head -1)
              oc wait --for=condition=Ready ${SHIPWRIGHT_CR} --timeout=5m
              oc get ${SHIPWRIGHT_CR} -o jsonpath='{range .status.conditions[*]}  {.type}: {.status} ({.reason}){"\n"}{end}'
              
              echo "CR status verified."
          - name: verify-images
            image: quay.io/openshift-pipeline/ci:latest
            env:
              - name: KUBECONFIG
                value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
              - name: SNAPSHOT
                value: $(params.SNAPSHOT)
            volumeMounts:
              - name: credentials
                mountPath: /credentials
            script: |
              #!/usr/bin/env bash
              set -ex -u -o pipefail
              
              dnf -y install jq skopeo

              # Configure skopeo auth for quay.io. Extracting quay.io credentials from the cluster's pull-secret
              oc get secret pull-secret -n openshift-config -o jsonpath='{.data.\.dockerconfigjson}' | \
                base64 -d | jq '{auths: {"quay.io": .auths["quay.io"]}}' > /tmp/auth.json
              chmod 600 /tmp/auth.json
              export REGISTRY_AUTH_FILE=/tmp/auth.json
              trap "rm -f /tmp/auth.json" EXIT
              
              #snapshot contents
              echo "$SNAPSHOT" | jq -r '.components[] | "\(.name): \(.containerImage)"'

              echo "1: Verifying snapshot images exist in registry"

              PASSED=0
              FAILED=0

              for IMAGE in $(echo "$SNAPSHOT" | jq -r '.components[].containerImage'); do
                  COMPONENT=$(echo "$SNAPSHOT" | jq -r --arg img "$IMAGE" '.components[] | select(.containerImage == $img) | .name')
                  SNAPSHOT_DIGEST="${IMAGE##*@}"

                  #   1. Check image exists in registry
                  if skopeo inspect --no-tags "docker://${IMAGE}" &>/dev/null; then
                      # Image exists -> verify the digest matches exactly
                      REGISTRY_DIGEST=$(skopeo inspect --no-tags "docker://${IMAGE}" | jq -r '.Digest')
                      if [ "$REGISTRY_DIGEST" == "$SNAPSHOT_DIGEST" ]; then
                          echo "PASS"
                          PASSED=$((PASSED + 1))
                      else
                          echo "FAIL - Digest mismatch - expected $SNAPSHOT_DIGEST, got $REGISTRY_DIGEST"
                          FAILED=$((FAILED + 1))
                      fi
                  else
                      echo "FAIL: Image not found in registry"
                      FAILED=$((FAILED + 1))
                  fi
              done
              
              if [ "$FAILED" -gt 0 ]; then
                  echo "Snapshot contains invalid/missing images."
                  exit 1
              fi
              
              echo "All snapshot images verified in registry"
              
              echo "2: Verifying snapshot components are referenced in bundle relatedImages to confirm the bundle was built correctly with latest commit"              
              CSV_NAME=$(oc get csv -n openshift-builds -o name | grep openshift-builds-operator | head -1)
              echo "Found CSV: ${CSV_NAME}"

              BUNDLE_RELATED_IMAGES=$(oc get "${CSV_NAME}" -n openshift-builds -o json | jq -r '.spec.relatedImages[]? | .image' 2>/dev/null || echo "")

              if [ -z "$BUNDLE_RELATED_IMAGES" ]; then
                  echo "No relatedImages found in CSV. Skipping bundle verification."
              else
                  BUNDLE_PASSED=0
                  BUNDLE_FAILED=0

                  # Verify each snapshot component (except bundle/fbc) is in bundle's relatedImages
                  for COMPONENT in $(echo "$SNAPSHOT" | jq -r '.components[] | select(.name | test("bundle|fbc") | not) | .name'); do
                      SNAPSHOT_DIGEST=$(echo "$SNAPSHOT" | jq -r --arg name "$COMPONENT" '.components[] | select(.name == $name) | .containerImage' | sed 's/.*@//')
                      
                      echo "Checking snapshot component: ${COMPONENT}"
                      if echo "$BUNDLE_RELATED_IMAGES" | grep -q "$SNAPSHOT_DIGEST"; then
                          echo "PASS: ${COMPONENT} -> found in bundle relatedImages"
                          BUNDLE_PASSED=$((BUNDLE_PASSED + 1))
                      else
                          echo "FAIL: ${COMPONENT} - Digest not found in bundle relatedImages"
                          BUNDLE_FAILED=$((BUNDLE_FAILED + 1))
                      fi
                  done
                  
                  echo "Snapshot components in bundle: ${BUNDLE_PASSED} passed, ${BUNDLE_FAILED} failed"
                  
                  if [ "$BUNDLE_FAILED" -gt 0 ]; then
                      echo "Bundle is missing snapshot component refs. Bundle was not built correctly."
                      exit 1
                  fi
              fi
              echo "All snapshot components verified in bundle relatedImages."
              
              echo "3: Verifying running operands match bundle and snapshot"
              # Note: daemonset/shared-resource-csi-driver-node containers[0] is external sidecar, skip it
              OPERANDS=(
                  "deployment/shipwright-build-controller"
                  "deployment/shipwright-build-webhook"
                  "deployment/shared-resource-csi-driver-webhook"
              )

              OPERAND_PASSED=0
              OPERAND_FAILED=0

              for OPERAND in "${OPERANDS[@]}"; do
                  OPERAND_IMAGE=$(oc get "$OPERAND" -n openshift-builds -o jsonpath='{.spec.template.spec.containers[0].image}')
                  
                  # for example: quay.io/org/image:tag@sha256:abc123
                  REPO_TAG="${OPERAND_IMAGE%@*}"        # quay.io/org/image:tag
                  REPO="${REPO_TAG%:*}"                 # quay.io/org/image
                  RUNNING_DIGEST="${OPERAND_IMAGE##*@}" # sha256:abc123

                  echo "Checking ${OPERAND}..."
                  echo "Image: ${REPO_TAG}"
                  echo "Running digest: ${RUNNING_DIGEST}"
                  
                  # Verify running digest exists in bundle's relatedImages (bundle deployed correctly)
                  if [ -n "$BUNDLE_RELATED_IMAGES" ]; then
                      if echo "$BUNDLE_RELATED_IMAGES" | grep -q "$RUNNING_DIGEST"; then
                          echo "PASS: Digest found in bundle relatedImages"
                      else
                          echo "FAIL: Running digest not found in bundle relatedImages"
                          OPERAND_FAILED=$((OPERAND_FAILED + 1))
                          continue
                      fi
                  fi
                  
                  # Verify running digest exists in snapshot (testing PR code)
                  if echo "$SNAPSHOT" | jq -e --arg digest "$RUNNING_DIGEST" '.components[] | select(.containerImage | contains($digest))' > /dev/null 2>&1; then
                      MATCHED_COMPONENT=$(echo "$SNAPSHOT" | jq -r --arg digest "$RUNNING_DIGEST" '.components[] | select(.containerImage | contains($digest)) | .name')
                      echo "PASS: Matches SNAPSHOT component '$MATCHED_COMPONENT'"
                      OPERAND_PASSED=$((OPERAND_PASSED + 1))
                  else
                      echo "FAIL: Running digest not found in SNAPSHOT. Not testing the PR/latest code."
                      OPERAND_FAILED=$((OPERAND_FAILED + 1))
                  fi
              done
              
              echo "${OPERAND_PASSED} passed, ${OPERAND_FAILED} failed"
              
              if [ "$OPERAND_FAILED" -gt 0 ]; then
                  echo "ERROR: ${OPERAND_FAILED} operand(s) failed verification"
                  exit 1
              fi
              
              echo "All running operands verified against bundle and snapshot"
              
    - name: run-e2e-tests
      description: Clone Shipwright repo and run e2e tests against deployed operator
      runAfter:
        - deploy-and-verify-operator
      timeout: "3h"
      taskSpec:
        volumes:
          - name: credentials
            emptyDir: { }
        steps:
          - name: get-kubeconfig
            ref:
              resolver: git
              params:
                - name: url
                  value: https://github.com/konflux-ci/build-definitions.git
                - name: revision
                  value: main
                - name: pathInRepo
                  value: stepactions/eaas-get-ephemeral-cluster-credentials/0.1/eaas-get-ephemeral-cluster-credentials.yaml
            params:
              - name: eaasSpaceSecretRef
                value: $(tasks.provision-eaas-space.results.secretRef)
              - name: clusterName
                value: "$(tasks.provision-cluster.results.clusterName)"
              - name: credentials
                value: credentials
          - name: run-e2e-tests
            image: quay.io/openshift-pipeline/ci:latest
            env:
              - name: KUBECONFIG
                value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
              - name: TEST_NAMESPACE
                value: "openshift-builds"
            volumeMounts:
              - name: credentials
                mountPath: /credentials
            script: |
              #!/usr/bin/env bash
              set -ex
              
              dnf -y install git golang
              export PATH=$PATH:$(go env GOPATH)/bin
              
              git clone https://github.com/shipwright-io/build.git /workspace/openshift-builds
              cd /workspace/openshift-builds
              
              export TEST_NAMESPACE="openshift-builds"
              export TEST_CONTROLLER_NAMESPACE="openshift-builds"
              export TEST_WATCH_NAMESPACE="openshift-builds"
              export TEST_E2E_SERVICEACCOUNT_NAME="pipeline"
              export TEST_IMAGE_REPO="ttl.sh/build-e2e"
              
              oc apply -n ${TEST_NAMESPACE} -R -f samples/v1beta1/buildstrategy/
              
              go run github.com/onsi/ginkgo/v2/ginkgo -r --randomize-all --timeout=1h --trace -v \
                --skip-file=e2e_vulnerability_scanning_test.go \
                --skip-file=e2e_pipelinerun_test.go \
                --skip="mutate image timestamp when using BuildKit|when a Buildkit build with a contextDir|when a heroku Buildpacks|when a BuildKit build runs with a custom target" \
                ./test/e2e/v1beta1